<!DOCTYPE html>
<html class="fuelux" lang="en">
  <head>
    <meta charset="utf-8">
    <title>Dipping Into RHIPE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="http://fuelux.exacttargetapps.com/fuelux/2.1/css/fuelux.css" rel="stylesheet" />
	<link href="http://fuelux.exacttargetapps.com/fuelux/2.1/css/fuelux-responsive.css" rel="stylesheet" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
	<script src="http://fuelux.exacttargetapps.com/fuelux/2.1/loader.min.js" type="text/javascript"></script>
    <link href="/css/docs.css" rel="stylesheet">
    <link href="/js/google-code-prettify/prettify.css" rel="stylesheet">	
	<link rel="shortcut icon" href="/favicon.ico">    
  </head>
  <body data-spy="scroll" data-target=".subnav" data-offset="50">
	<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
	<div class="container">
	  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
	  </a>
	  <a class="brand" href="http://saptarshiguha.github.io/RHIPE/">RHIPE Blog</a>
	  <div class="nav-collapse">
		<ul class="nav">		  
		  <li class="">
			<a href="https://github.com/saptarshiguha/RHIPE">RHIPE on GitHub</a>
		  </li>
		  <li class=""><a href="">Function Index</a>
		  <li class=""><a href="">Downloads</a>
		<!-- <li class="dropdown"> -->
		<!-- 	<a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-list"></i>Sticky Pages <b class="caret"></b></a> -->
		<!-- 		<ul class="dropdown-menu">					 -->
		<!-- 			<li class=""><a href="https://github.com/placeholder1" rel="tooltip" title="placeholder1" target="_blank">placeholder1</a></li>					 -->
		<!-- 			<li class=""><a href="http://rhipe.github.com/placeholder2" rel="tooltip" title="placeholder2">placeholder2</a></li> -->
					
		<!-- 		</ul> -->
		<!-- 	      </li> -->
			      
		</ul>		
	  </div>
	</div>
  </div>
</div>  
	<div class="container">	
		<div class="marketing">
		<div class="content">    
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'rhipe'; // required: replace example with your forum shortname
		var disqus_identifier = '/RHIPE/dipping-into-rhipe';
		var disqus_url = 'http://rhipe.github.com/RHIPE/dipping-into-rhipe';

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>
<div class="row">	
	<div class="span11 column">
	
<div class="row">	
	<div class="span11 column">
		<h1>Dipping Into RHIPE</h1>
	</div>
<!-- </div>		 -->
<!-- <div class="row">	 -->
	<div class="span11 column">
	  <h5><strong>May 27, 2013 <small>.
	  <!--  . -->
	  <!-- <a href="http://rhipe.github.com/RHIPE/dipping-into-rhipe#disqus_thread" data-disqus-identifier="/RHIPE/dipping-into-rhipe">Comments</a> -->
	  </small></strong>
<small>Tags:  <a href="/tags/rhwatch" title="View posts tagged with &quot;rhwatch&quot;"><u>rhwatch</u></a>     <a href="/tags/map" title="View posts tagged with &quot;map&quot;"><u>map</u></a>    </small>
		<!-- <a href="https://twitter.com/share" class="twitter-share-button" data-via="rhipe">Tweet</a> <g:plusone size="medium"></g:plusone></h5> -->
	</div>		
	<!-- <div class="span6 column"> -->
	<!-- 	<p class="pull-right"> <a href="/RHIPE/jekyll-introduction" title="Previous Post: Jekyll Introduction"><i class="icon-chevron-left"></i></a> 	    </p>   -->
	<!-- </div>	 -->
</div>
<!-- <div class="row"> -->
<!-- 	<div class="span11 column"> -->
<!-- 		<hr> -->
<!-- 	</div> -->
<!-- </div> -->
</div>
</div>

    <!-- * mytoc -->


<!-- {:toc} -->


<p>In this first post of the RHIPE blog, I introduce to the reader some basic
commands. These commands should illustrate how to submit jobs via RHIPE, monitor
it's execution and retrieve results.</p>

<h2>Setting Some Useful Options via <code>rhoptions</code></h2>

<pre><code>options(java.parameters="-Xrs")

rhoptions(HADOOP.TMP.FOLDER = sprintf(path-to-user-specified-temp-folder-on-hdfs),
    job.status.overprint    = TRUE,
    write.job.info      = TRUE)
</code></pre>

<p>The above options in order</p>

<p><code>java.parameters="-Xrs"</code>
: RHIPE requires rJava. Interrupting control in the R console via <code>CTRL-C</code>
causes R to quit immediately. Setting this option prevents that. Very useful.</p>

<p><code>HADOOP.TMP.FOLDER</code>
: a location e.g. <code>/user/sguha/tmp</code> on the HDFS. RHIPE will use this to create
temporary files. You really need to define one.</p>

<p><code>job.status.overprint</code>
: when job output is displayed in the console, instead of scrolling through the
window, the status will be displayed over the previous output.</p>

<p><code>write.job.info</code>
: the job info(number of records processed, number saved, time taken etc) will
be saved in the output folder</p>

<h2>Initialize RHIPE</h2>

<p>This is the first thing, type</p>

<pre><code>rhinit()
</code></pre>

<h2>Can You Browse the HDFS?</h2>

<p><code>rhls</code> takes a path on the HDFS and returns a data frame similar to <code>ls</code> on UNIX
systems. You can replace <code>rhoptions()$HADOOP.TMP.FOLDER</code> with any path on the
HDFS e.g. <code>/</code>.</p>

<pre><code>rhls(rhoptions()$HADOOP.TMP.FOLDER)
</code></pre>

<h2>Your First Job</h2>

<p>Let's try and compute pi via a monte carlo simulation. We'll do it in R, via the
<code>parallel</code> library. Code is taken from <a href="http://www.mathworks.com/products/parallel-computing/examples.html?file=/products/demos/shipping/distcomp/paralleldemo_parfor_pi.html">here</a></p>

<pre><code>R &lt;- 1
R2 &lt;- R^2
N &lt;- 1e6
PI &lt;- function(r){
  x &lt;- R*runif(2)
  sum(x*x)&lt;=R2
}
total &lt;- mclapply(1:N,PI)
sum(unlist(total))*4/N
</code></pre>

<p>The RHIPE version would be</p>

<pre><code>R &lt;- 1
R2 &lt;- R^2
N  &lt;- 1e6
total &lt;- rhwatch(function(key,value){
  rhcollect(1L,PI(value))
}
                 ,reduce=rhoptions()$templates$scalarsummer,
                 ,input=N,read=FALSE)
</code></pre>

<p>If the job succeeds, then <code>total</code> will contain information about the job. Type
<code>total</code> in your R console. It contains information about the counters, time
taken to run, and the configuration that went into creating the job.</p>

<h3>Getting Back the Results</h3>

<p>If however, <code>read=TRUE</code> (the default), then the sum is read back into
<code>total</code>. Since we have set <code>read=FALSE</code> we have to read it:</p>

<pre><code>total &lt;- rhread(total)
</code></pre>

<p>And then our estimate of pi is <code>total[[1]][[2]]*4/N</code>.</p>

<h2>Your Second Job: Creating Text Data</h2>

<p>Taken from the mailing list (see
<a href="https://groups.google.com/d/msg/rhipe/ovPooyYOIxE/936iCkXVxigJ">this thread</a>)</p>

<p>We need to generate some fake data as this</p>

<pre><code>05,WMB,02064934-5360-4f06-aadb-6d44f862b016,30.76,30.75,35,14,2012-05-16 14:48:33:173
52,XOM,7c9a6373-4910-4ec5-bf0a-d95d0fbf3994,82.5,82.5,7,31,2012-05-16 14:48:33:174
52,XOM,5d91d383-ab6e-4961-884e-0f6ba813eb19,82.5,82.5,7,14,2012-05-16 14:48:33:175
52,XOM,3658e7dc-258d-412a-9c4f-27ae19b57fa1,82.51,82.5,7,14,2012-05-16 14:48:33:176
52,XOM,200d9e36-827b-431c-b487-34ab2b224639,82.51,82.5,8,14,2012-05-16 14:48:33:177
</code></pre>

<p>This code will generate 387MB of text that looks like the above</p>

<pre><code>xtime &lt;- as.character(Sys.time())
map &lt;- expression({
  for(x in map.values)
    rhcollect(NULL,
              paste(sample(1:100,1),
                    paste(sample(letters,3),collapse=""),
                    paste(sample(letters,36,replace=TRUE),collapse=""),
                    runif(1),runif(1),runif(1),runif(1),xtime,sep=",",collapse=","))
})

datMat &lt;- rhwatch(map=map,reduce=1, input=c(3000000,50)
                  ,output=rhfmt(type='text',folders="/user/sguha/tmp/txt",writeKey=FALSE)
                  ,read=FALSE)
</code></pre>

<p>We need to compute some information for a linear regression(again, see the above
thread for context)</p>

<pre><code>map&lt;- expression({
  datMat&lt;- do.call("rbind", strsplit(unlist(map.values),","))
  datMat &lt;- t(apply(datMat[,c(4,5,6,7)],1,as.numeric))
  yMat&lt;- as.matrix(datMat[,1])
  datMat&lt;- cbind(1, as.matrix(datMat[, c(2,3,4)]))

  val1 &lt;- crossprod(datMat, datMat)
  val2 &lt;- crossprod(datMat, yMat)
  rhcollect("temp_out",cbind(val1,val2))
})

reduce&lt;- expression(
    pre = { .sum &lt;- 0},
    reduce = { for(x in reduce.values) .sum &lt;- .sum +x},
    post={
      if(.rhipe.current.state == "map.combine"){
        rhcollect( reduce.key, .sum)
      }else{
        x &lt;- .sum[, -dim(.sum)[2]]
        y &lt;- .sum[,  dim(.sum)[2]]
        betas &lt;- solve(as.matrix(x), as.matrix(y))
        rhcollect("betas", betas)
      }
    })

z &lt;- rhwatch(map=map,reduce=reduce,combine=TRUE
             ,input=rhfmt("/user/sguha/tmp/txt",type='text')
             ,jobname = "Rhipe_OLS",mapred=list(mapred.reduce.tasks=1))
</code></pre>

<h2>Counting Words</h2>

<p>We need to count unique symbols occurring in the 2nd column of the above fake
data.</p>

<pre><code>map&lt;- expression({
  datMat&lt;- do.call("rbind", strsplit(unlist(map.values),","))
  sapply(datMat[,2],function(a) rhcollect(a,1))
})

uniqueCount &lt;- rhwatch(map=map ,reduce=rhoptions()$templates$scalarsummer
                       ,input=rhfmt("/user/sguha/tmp/txt",type='text')
                       ,jobname = "SymbolCount")
</code></pre>
		
</div>
    

		</div>		 
	 </div>   
	<!-- <footer class="footer">
  <div class="container">
	<p class="pull-right"> <a href="/RHIPE/jekyll-introduction" title="Previous Post: Jekyll Introduction">&laquo; Previous Blog Post</a> 	  |  <a href="#">Back to top</a>  |   </p>        
	<p>Page last generated on May 28, 2013</p>
	<p>If need be, <a href="https://github.com/rhipe/Feedback/issues/new" title="Leave feedback"  target="_blank" >leave me some feedback</a>.</p>	
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>	
  </div>
</footer> -->
    <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>    
    
	<script src="/js/custom.js" type="text/javascript"></script>	
	
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'rhipe'; // required: replace example with your forum shortname

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>
	
	<!-- Google Analytics -->
	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-29830549-1']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>	
  </body>
</html>
